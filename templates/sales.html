{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="text-white">ðŸ›’ Sales Management</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createSaleModal">
                <i class="fas fa-plus me-2"></i>Create Sale
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Total (PKR)</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><strong>{{ sale[1] }}</strong></td>
                        <td>{{ sale[2] }}</td>
                        <td><span class="badge bg-success fs-6">PKR {{ sale[4] }}</span></td>
                        <td>{{ sale[5] }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewSale('{{ sale[3] }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSale({{ sale[0] }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Sale Modal -->
<div class="modal fade" id="createSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Customer Name</label>
                    <input type="text" class="form-control" id="saleCustomer" placeholder="Walk-in Customer">
                </div>
                
                <div id="saleItems">
                    <div class="row mb-2">
                        <div class="col-4">
                            <input type="text" class="form-control" placeholder="Product Name" name="itemName">
                        </div>
                        <div class="col-2">
                            <input type="number" class="form-control" placeholder="Qty" name="itemQty" value="1">
                        </div>
                        <div class="col-3">
                            <input type="number" step="0.01" class="form-control" placeholder="Price" name="itemPrice">
                        </div>
                        <div class="col-2">
                            <input type="number" step="0.01" class="form-control" placeholder="Total" name="itemTotal" readonly>
                        </div>
                        <div class="col-1">
                            <button type="button" class="btn btn-success btn-sm" onclick="addSaleItem()">+</button>
                        </div>
                    </div>
                </div>
                
                <div class="text-end mt-3">
                    <h4>Grand Total: PKR <span id="grandTotal">0.00</span></h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createSale()">Create Sale</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addSaleItem() {
    const itemsDiv = document.getElementById('saleItems');
    const newItem = itemsDiv.children[0].cloneNode(true);
    
    // Clear inputs
    newItem.querySelectorAll('input').forEach(input => input.value = input.name === 'itemQty' ? '1' : '');
    
    // Change button to remove
    const button = newItem.querySelector('button');
    button.innerHTML = '-';
    button.className = 'btn btn-danger btn-sm';
    button.onclick = function() { 
        this.closest('.row').remove(); 
        updateGrandTotal(); 
    };
    
    itemsDiv.appendChild(newItem);
    
    // Add event listeners
    const qtyInput = newItem.querySelector('input[name="itemQty"]');
    const priceInput = newItem.querySelector('input[name="itemPrice"]');
    
    qtyInput.oninput = priceInput.oninput = function() {
        calculateItemTotal(this.closest('.row'));
    };
}

function calculateItemTotal(row) {
    const qty = parseFloat(row.querySelector('input[name="itemQty"]').value) || 0;
    const price = parseFloat(row.querySelector('input[name="itemPrice"]').value) || 0;
    const total = qty * price;
    
    row.querySelector('input[name="itemTotal"]').value = total.toFixed(2);
    updateGrandTotal();
}

function updateGrandTotal() {
    const totals = document.querySelectorAll('input[name="itemTotal"]');
    let grandTotal = 0;
    totals.forEach(total => {
        grandTotal += parseFloat(total.value) || 0;
    });
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
}

function createSale() {
    const customer = document.getElementById('saleCustomer').value || 'Walk-in Customer';
    const items = [];
    
    document.querySelectorAll('#saleItems .row').forEach(row => {
        const name = row.querySelector('input[name="itemName"]').value;
        const quantity = parseInt(row.querySelector('input[name="itemQty"]').value);
        const price = parseFloat(row.querySelector('input[name="itemPrice"]').value);
        const total = parseFloat(row.querySelector('input[name="itemTotal"]').value);
        
        if (name && quantity && price) {
            items.push({ name, quantity, price, total });
        }
    });
    
    if (items.length === 0) {
        alert('Please add at least one item');
        return;
    }
    
    fetch('/create_sale', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ customer, items })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('âœ… Sale created! Invoice: ' + result.invoice);
            location.reload();
        }
    });
}

function viewSale(itemsJson) {
    const items = JSON.parse(itemsJson);
    let itemsText = 'Sale Items:\n\n';
    items.forEach(item => {
        itemsText += `${item.name} - Qty: ${item.quantity}, Price: PKR ${item.price}, Total: PKR ${item.total}\n`;
    });
    alert(itemsText);
}

function deleteSale(saleId) {
    if (confirm('Are you sure you want to delete this sale? Stock will be restored.')) {
        fetch(`/delete_sale/${saleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('âœ… Sale deleted and stock restored!');
                location.reload();
            }
        });
    }
}

// Initialize event listeners for first item
document.addEventListener('DOMContentLoaded', function() {
    const firstRow = document.querySelector('#saleItems .row');
    const qtyInput = firstRow.querySelector('input[name="itemQty"]');
    const priceInput = firstRow.querySelector('input[name="itemPrice"]');
    
    qtyInput.oninput = priceInput.oninput = function() {
        calculateItemTotal(firstRow);
    };
});
</script>
{% endblock %}