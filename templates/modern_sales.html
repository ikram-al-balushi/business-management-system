{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h2 class="display-5 fw-bold text-white mb-3">Sales Management</h2>
        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#newSaleModal">
            <i class="fas fa-plus me-2"></i>Create New Sale
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Sales History</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><strong class="text-primary">{{ sale[1] }}</strong></td>
                        <td>{{ sale[2] or 'Walk-in Customer' }}</td>
                        <td>{{ sale[3] or '-' }}</td>
                        <td><span class="badge bg-success fs-6">${{ sale[5] }}</span></td>
                        <td>
                            <span class="badge {% if sale[6] == 'credit' %}bg-warning{% else %}bg-info{% endif %}">
                                {{ sale[6]|title }}
                            </span>
                        </td>
                        <td>{{ sale[7] }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewInvoice('{{ sale[4] }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="/print_invoice/{{ sale[1] }}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-print"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>Create New Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Customer Name</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">WhatsApp Number</label>
                            <input type="text" class="form-control" id="customerPhone" placeholder="+1234567890">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Payment Type</label>
                            <select class="form-control" id="paymentType">
                                <option value="cash">Cash</option>
                                <option value="credit">Credit</option>
                                <option value="card">Card</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendWhatsApp">
                            <label class="form-check-label fw-bold" for="sendWhatsApp">
                                <i class="fab fa-whatsapp me-1 text-success"></i>Send invoice via WhatsApp
                            </label>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Invoice Items</h6>
                        </div>
                        <div class="card-body">
                            <div id="itemsList">
                                <div class="row g-2 mb-2 align-items-end">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Product</label>
                                        <input type="text" class="form-control" placeholder="Product Name" name="product_name">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Qty</label>
                                        <input type="number" class="form-control" placeholder="Qty" name="quantity">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Price</label>
                                        <input type="number" step="0.01" class="form-control" placeholder="Price" name="price">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Total</label>
                                        <input type="number" step="0.01" class="form-control" placeholder="Total" name="total" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-success w-100" onclick="addItem()">
                                            <i class="fas fa-plus me-1"></i>Add Item
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <h4 class="text-success">Grand Total: $<span id="grandTotal">0.00</span></h4>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success btn-lg" onclick="createSale()">
                    <i class="fas fa-check me-1"></i>Create Sale
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addItem() {
    const itemsList = document.getElementById('itemsList');
    const newItem = itemsList.children[0].cloneNode(true);
    newItem.querySelectorAll('input').forEach(input => input.value = '');
    newItem.querySelector('button').innerHTML = '<i class="fas fa-trash"></i>';
    newItem.querySelector('button').className = 'btn btn-danger w-100';
    newItem.querySelector('button').onclick = function() { this.parentElement.parentElement.remove(); updateGrandTotal(); };
    itemsList.appendChild(newItem);
    
    const qtyInput = newItem.querySelector('input[name="quantity"]');
    const priceInput = newItem.querySelector('input[name="price"]');
    const totalInput = newItem.querySelector('input[name="total"]');
    
    function calculateTotal() {
        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        totalInput.value = (qty * price).toFixed(2);
        updateGrandTotal();
    }
    
    qtyInput.addEventListener('input', calculateTotal);
    priceInput.addEventListener('input', calculateTotal);
}

function updateGrandTotal() {
    const totals = document.querySelectorAll('input[name="total"]');
    let grandTotal = 0;
    totals.forEach(total => {
        grandTotal += parseFloat(total.value) || 0;
    });
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
}

function createSale() {
    const items = [];
    const itemRows = document.getElementById('itemsList').children;
    
    for (let row of itemRows) {
        const productName = row.querySelector('input[name="product_name"]').value;
        const quantity = parseFloat(row.querySelector('input[name="quantity"]').value);
        const price = parseFloat(row.querySelector('input[name="price"]').value);
        const total = parseFloat(row.querySelector('input[name="total"]').value);
        
        if (productName && quantity && price) {
            items.push({
                product_name: productName,
                quantity: quantity,
                price: price,
                total: total
            });
        }
    }
    
    const saleData = {
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        payment_type: document.getElementById('paymentType').value,
        send_whatsapp: document.getElementById('sendWhatsApp').checked,
        items: items
    };
    
    fetch('/create_invoice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const whatsappSent = document.getElementById('sendWhatsApp').checked;
            let message = 'âœ… Sale created successfully! Invoice: ' + result.invoice_no;
            if (whatsappSent) {
                message += '\nðŸ“± WhatsApp message will be sent shortly!';
            }
            alert(message);
            location.reload();
        }
    });
}

function viewInvoice(itemsJson) {
    const items = JSON.parse(itemsJson);
    let itemsText = 'ðŸ“‹ Invoice Items:\n\n';
    items.forEach(item => {
        itemsText += `â€¢ ${item.product_name} - Qty: ${item.quantity}, Price: $${item.price}, Total: $${item.total}\n`;
    });
    alert(itemsText);
}

// Initialize first row calculations
document.addEventListener('DOMContentLoaded', function() {
    const firstRow = document.getElementById('itemsList').children[0];
    const qtyInput = firstRow.querySelector('input[name="quantity"]');
    const priceInput = firstRow.querySelector('input[name="price"]');
    
    function calculateTotal() {
        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        firstRow.querySelector('input[name="total"]').value = (qty * price).toFixed(2);
        updateGrandTotal();
    }
    
    qtyInput.addEventListener('input', calculateTotal);
    priceInput.addEventListener('input', calculateTotal);
});
</script>
{% endblock %}